#!/usr/bin/env bash

set -euo pipefail

# shellcheck source=bin/lib/fns.bash
source "$(dirname "${BASH_SOURCE[0]}")/lib/fns.bash"

list_all_urls() {
  # shellcheck disable=SC2046
  wget -qO- $([ -n "${GITHUB_API_TOKEN-}" ] && echo "--header 'Authorization: token $GITHUB_API_TOKEN'") https://api.github.com/repos/cli/cli/releases | jq -r '.[].assets[].browser_download_url' | tac
}

filter_usable_releases() {
  (grep "https://github.com/cli/cli/releases/download/v[0-9.]\+/gh_[0-9.]\+_$(cli_platform)_$(cli_arch).tar.gz" || true)
}

extract_version_from_url() {
  cut -d / -f 8 | cut -c2-
}

list_all_in_lines() {
  list_all_urls | filter_usable_releases | extract_version_from_url
}

list_all() {
  list_all_in_lines | xargs echo
}

if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
  list_all
fi
